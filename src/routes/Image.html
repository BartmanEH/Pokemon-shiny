<script>
  import { onMount } from 'svelte';

  export let fn = '';
  export let cfn = undefined;
  export let normal = undefined;

  const sourcePath = 'https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Pokemon%20-%20256x256/';
  // const sourcePath = 'https://raw.githubusercontent.com/ZeChrales/PogoAssets/master/pokemon_icons/';

  const dpr = window.devicePixelRatio || 1;
  const imgSrc = cfn || getImgSrc(fn, normal);
  const proxySrc = cfn || getProxyImgSrc(imgSrc);

  function getImgSrc(fn, normal) {
    let _fn = `pokemon_icon_${fn}${normal ? '' : '_shiny'}.png`;
    if (location.hash.indexOf('#dev=') === 0) {
      return `${location.hash.split('=').pop()}${_fn}`;
    }
    return `${sourcePath}${_fn}`;
  }

  function getProxyImgSrc(src = '') {
    return `https://images.weserv.nl/?dpr=${dpr}&w=200&il&url=${src}`
  }

  let imgRef;

  onMount(() => {
    const handleImgError = () => {
      console.error('handleImgError', imgRef.src, imgSrc);
      if (imgRef.src !== imgSrc) {
        imgRef.src = imgSrc;
      }
    };

    imgRef.addEventListener('error', handleImgError);
    return () => imgRef.removeEventListener('error', handleImgError);
  });
</script>

<img
  bind:this={imgRef}
  class="pm-img"
  alt=""
  src={proxySrc}
  loading="lazy"
  width="200"
  height="200"
  intrinsicsize="120x120"
/>
